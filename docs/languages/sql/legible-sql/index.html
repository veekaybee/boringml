<!doctype html><html lang=en dir=ltr>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Writing legible code is seen as the hallmark of a competent developer, and for good reason. If you can&rsquo;t read what you wrote, you can&rsquo;t change what you wrote. There are lots of organizations, especially once you get to larger companies where programming isn&rsquo;t the core competency or value center, that are prime examples of this. The result is a mess that not only impacts the code, but the entire company or business.">
<meta name=theme-color content="#FFFFFF">
<meta name=color-scheme content="light dark"><meta property="og:title" content="Legible SQL">
<meta property="og:description" content="Writing legible code is seen as the hallmark of a competent developer, and for good reason. If you can&rsquo;t read what you wrote, you can&rsquo;t change what you wrote. There are lots of organizations, especially once you get to larger companies where programming isn&rsquo;t the core competency or value center, that are prime examples of this. The result is a mess that not only impacts the code, but the entire company or business.">
<meta property="og:type" content="article">
<meta property="og:url" content="http://boringml.com/docs/languages/sql/legible-sql/"><meta property="article:section" content="docs">
<meta property="article:modified_time" content="2022-01-06T09:45:09-05:00">
<title>Legible SQL | Boring Machine Learning</title>
<link rel=manifest href=/manifest.json>
<link rel=icon href=/favicon.png type=image/x-icon>
<link rel=stylesheet href=/book.min.46181bc93375ba932026e753b37c40e6ff8bb16a9ef770c78bcc663e4577b1ba.css integrity="sha256-RhgbyTN1upMgJudTs3xA5v+LsWqe93DHi8xmPkV3sbo=" crossorigin=anonymous>
<script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.96c7050b3fbe4e946f8e7fe5e0a41ccc19273c73de3bade4b5e6c9dc6c3d600a.js integrity="sha256-lscFCz++TpRvjn/l4KQczBknPHPeO63ktebJ3Gw9YAo=" crossorigin=anonymous></script>
</head>
<body dir=ltr>
<input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control>
<main class="container flex">
<aside class=book-menu>
<div class=book-menu-content>
<nav>
<h2 class=book-brand>
<a class="flex align-center" href=/><img src=/logo.png alt=Logo><span>Boring Machine Learning</span>
</a>
</h2>
<div class=book-search>
<input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/>
<div class="book-search-spinner hidden"></div>
<ul id=book-search-results></ul>
</div>
<ul>
<li class=book-section-flat>
<a href=http://boringml.com/docs/languages/>Languages</a>
<ul>
<li>
<input type=checkbox id=section-8164995f4ca3a5480a8dc157c5688ca8 class=toggle>
<label for=section-8164995f4ca3a5480a8dc157c5688ca8 class="flex justify-between">
<a href=http://boringml.com/docs/languages/python/>Python</a>
</label>
<ul>
<li>
<a href=http://boringml.com/docs/languages/python/strptime/>strptime and strftime</a>
</li>
<li>
<a href=http://boringml.com/docs/languages/python/venv/>venv</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-16696fcaf676797c81cf5e45e5de0279 class=toggle>
<label for=section-16696fcaf676797c81cf5e45e5de0279 class="flex justify-between">
<a href=http://boringml.com/docs/languages/scala/>Scala</a>
</label>
<ul>
<li>
<a href=http://boringml.com/docs/languages/scala/build-sbt/>build.sbt and build.Scala</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-724b24b6e475c23be17bd4b512fe832d class=toggle checked>
<label for=section-724b24b6e475c23be17bd4b512fe832d class="flex justify-between">
<a href=http://boringml.com/docs/languages/sql/>SQL</a>
</label>
<ul>
<li>
<a href=http://boringml.com/docs/languages/sql/legible-sql/ class=active>Legible SQL</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-32778f62eb3265d41d230b051a98557a class=toggle>
<label for=section-32778f62eb3265d41d230b051a98557a class="flex justify-between">
<a href=http://boringml.com/docs/languages/java/>Java</a>
</label>
<ul>
<li>
<a href=http://boringml.com/docs/languages/java/arrays/>is_set</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-5244711b3ae5943d25076a75246efe07 class=toggle>
<label for=section-5244711b3ae5943d25076a75246efe07 class="flex justify-between">
<a href=http://boringml.com/docs/languages/php/>PHP</a>
</label>
<ul>
<li>
<a href=http://boringml.com/docs/languages/php/arrays/>is_set</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-3c4b9ad27a844def3e7d21cf2decb606 class=toggle>
<label for=section-3c4b9ad27a844def3e7d21cf2decb606 class="flex justify-between">
<a href=http://boringml.com/docs/recsys/>Recsys</a>
</label>
<ul>
<li>
<a href=http://boringml.com/docs/recsys/minhash/>Implementing Minhash</a>
</li>
<li>
<a href=http://boringml.com/docs/recsys/jaccard-similarity/>Jaccard Similarity</a>
</li>
<li>
<a href=http://boringml.com/docs/recsys/precision-and-recall/>Precision and Recall</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-993c2a7ec1f9c0d65a914f6698e5bb93 class=toggle>
<label for=section-993c2a7ec1f9c0d65a914f6698e5bb93 class="flex justify-between">
<a href=http://boringml.com/docs/platforms/>Platforms</a>
</label>
<ul>
<li>
<input type=checkbox id=section-d34f17f99c2c17870b793497139db159 class=toggle>
<label for=section-d34f17f99c2c17870b793497139db159 class="flex justify-between">
<a href=http://boringml.com/docs/platforms/cloud/>Cloud</a>
</label>
<ul>
<li>
<input type=checkbox id=section-9bf714ba1159b4c6def009bc6eac7dc0 class=toggle>
<label for=section-9bf714ba1159b4c6def009bc6eac7dc0 class="flex justify-between">
<a href=http://boringml.com/docs/platforms/cloud/aws/>Aws</a>
</label>
<ul>
<li>
<a href=http://boringml.com/docs/platforms/cloud/aws/lambdas/>Lambdas</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href=http://boringml.com/docs/platforms/kubernetes/>Kubernetes</a>
</li>
<li>
<input type=checkbox id=section-1b21d1cd61c37cc32012a0886c8a3a1e class=toggle>
<label for=section-1b21d1cd61c37cc32012a0886c8a3a1e class="flex justify-between">
<a role=button>Spark</a>
</label>
<ul>
<li>
<a href=http://boringml.com/docs/platforms/spark/create-data-python/>Sample data in PySpark</a>
</li>
</ul>
</li>
<li>
<a href=http://boringml.com/docs/platforms/airflow/>Airflow</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-8524f085204099c73bb397c727f0b9fd class=toggle>
<label for=section-8524f085204099c73bb397c727f0b9fd class="flex justify-between">
<a role=button>Computer Science</a>
</label>
<ul>
<li>
<a href=http://boringml.com/docs/computer-science/hash-aggregate/>Hash aggregates</a>
</li>
</ul>
</li>
<li>
<a href=http://boringml.com/docs/what-is-ml/>What is machine learning engineering?</a>
</li>
<li>
<a href=http://boringml.com/docs/about/>About Me</a>
</li>
</ul>
</nav>
<script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>
</div>
</aside>
<div class=book-page>
<header class=book-header>
<div class="flex align-center justify-between">
<label for=menu-control>
<img src=/svg/menu.svg class=book-icon alt=Menu>
</label>
<strong>Legible SQL</strong>
<label for=toc-control>
</label>
</div>
</header>
<article class=markdown><p>Writing legible code is seen as the hallmark of a competent developer, and for good reason. If you can&rsquo;t read what you wrote, you can&rsquo;t change what you wrote. There are lots of organizations, especially once you get to larger companies where programming isn&rsquo;t the core competency or value center, that are prime examples of this. The result is a mess that not only impacts the code, but the entire company or business.</p>
<p>There are great essays and books on reproducible code in almost every imaginable compiled and interpreted language, from Python, to Java, and great generalist essays, like Knuth&rsquo;s on writing reproducible code.</p>
<p>But what about SQL, still the #1 data language of choice in 80% of the tech enterprise world?</p>
<h2 id=there-are-a-couple-problems-with-making-sql-legible>
There are a couple problems with making SQL legible
<a class=anchor href=#there-are-a-couple-problems-with-making-sql-legible>#</a>
</h2>
<p>SQL is often the redheaded stepchild of computer languages.</p>
<p>First, because it&rsquo;s a declarative language, it&rsquo;s hard to do the same kind of concepts that are super-easy in almost any other language: loops, recursion, functions, or even declaring variables. You can do these things in T-SQL, but learning T-SQL and optimizing queries in it is almost not worth it if you just need to pull x dataset for sampling and want to spend most of your time in Python or R analyzing said data, or Y dataset with a,b,and c business logic requirements built in. As a result, it&rsquo;s hard to see SQL as logical and amenable to logical constraints or exceptions, as in &ldquo;regular&rdquo; languages. The other issue is that SQL is often seen as a necessary evil and developers often try to force their way through it in order to write ORMs instead of seeing it as a value-add for data teams.</p>
<p>Second, because it doesn&rsquo;t need to be written in a specific format, saved to an editor, or checked into repositories, SQL snippets often end up languishing in Oracle windows, Evernotes, text files in random project directories, and even in emails (guilty as charged -I&rsquo;ve used Outlook as a SQL query storage mechanism before.)</p>
<p>Even though there is a lot of hype about NoSQL data systems, most data scientists will tell you that they spend a <strong>LOT</strong> of time getting data sets ready in MySQL or Oracle or SQL Server or Postgres as part of their data flow.</p>
<p>Then these code snippets are usually stored away in everything from Word docs, to Evernotes, to text files in project directories. Because SQL is declarative and run one person at a time, most times, unless it&rsquo;s being run as part of a Python or R call through the respective APIs, it&rsquo;s not even put into version control.</p>
<p>But what about when SQL code needs to be stored or rerun? How to read the jumbled mess of nested subqueries and tons of case statements necessitated by the fact that the business logic for the data requires it?</p>
<p>Here are a couple tips from painful personal experience. All of these are guidelines, by the way, and geared towards data scientists/analysts working alone on manual SQL tasks that are not part of an automated data flow (but even in that case, cleaning up code will make other components easier to read, too)</p>
<p>The guidelines don&rsquo;t mean you have to use them every time. I&rsquo;ve personally written some pretty ugly, functional SQL when it was crunch time. But they will make your life prettier and easier. This is not specifically about optimizing SQL, which I&rsquo;ll cover in another post.</p>
<h2 id=how-to-make-sql-legible-to-other-humans>
How to make SQL legible to other humans
<a class=anchor href=#how-to-make-sql-legible-to-other-humans>#</a>
</h2>
<h3 id=1-make-all-declarative-keywords-their-own-new-line-if-possible-because-its-easier-to-read-and-understand-which-table-and-which-columns-are-being-referenced>
1. Make all declarative keywords their own new line if possible because it&rsquo;s easier to read and understand which table and which columns are being referenced:
<a class=anchor href=#1-make-all-declarative-keywords-their-own-new-line-if-possible-because-its-easier-to-read-and-understand-which-table-and-which-columns-are-being-referenced>#</a>
</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql>
<span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> tablex
<span style=color:#66d9ef>WHERE</span> variabley<span style=color:#f92672>=</span>z 
<span style=color:#66d9ef>AND</span> variablea<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span>
<span style=color:#66d9ef>AND</span> variableb<span style=color:#f92672>=</span><span style=color:#ae81ff>15</span>
</code></pre></div><p>is more legible than</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql>
<span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> tablex <span style=color:#66d9ef>where</span> variabley<span style=color:#f92672>=</span>z <span style=color:#66d9ef>AND</span> variablea<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span> <span style=color:#66d9ef>AND</span> variableb<span style=color:#f92672>=</span><span style=color:#ae81ff>15</span>
</code></pre></div><h3 id=2--make-all-declarative-statements-and-db-functions-uppercase>
2. Make all declarative statements and DB functions uppercase
<a class=anchor href=#2--make-all-declarative-statements-and-db-functions-uppercase>#</a>
</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql>
<span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> tablex
<span style=color:#66d9ef>WHERE</span> variabley<span style=color:#f92672>=</span>z 
<span style=color:#66d9ef>AND</span> variablea<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span>
<span style=color:#66d9ef>AND</span> variableb<span style=color:#f92672>=</span><span style=color:#ae81ff>15</span>
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> RAND()
<span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>1</span>
</code></pre></div><p>is more legible than</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql>
<span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> tablex
<span style=color:#66d9ef>where</span> variabley<span style=color:#f92672>=</span>z 
<span style=color:#66d9ef>AND</span> variablea<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span>
<span style=color:#66d9ef>AND</span> variableb<span style=color:#f92672>=</span><span style=color:#ae81ff>15</span>
<span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> RAND()
<span style=color:#66d9ef>limit</span> <span style=color:#ae81ff>1</span>
</code></pre></div><p>It&rsquo;s easier to read all uppercase. Or, alternatively, if you don&rsquo;t have time (and it is kind of annoying to remember), make them all lowercase. Just don&rsquo;t mix cases. And uppercase is preferable in any kind of documentation. The same is true for tablenames. Make them either all lower case or all uppercase. Lowercase is preferable to avoid mixing them up with declaratives.</p>
<h3 id=3-try-to-limit-the-amount-of-subqueries-in-your-query>
3. Try to limit the amount of subqueries in your query.
<a class=anchor href=#3-try-to-limit-the-amount-of-subqueries-in-your-query>#</a>
</h3>
<p>Yes, subqueries are much, much faster if you&rsquo;re aggregating across multiple data sets. Check out <a href=https://www.periscope.io/blog/use-subqueries-to-count-distinct-50x-faster.html>this post</a> for more detail as to why. But when you get to the point where you have more than 4 subqueries, you probably want to do some optimization, or if possible, rebuild your tables in a way that makes more sense. If you find yourself CONSTANTLY having to write subqueries, it&rsquo;s a sign that your data schemas are architected incorrectly.</p>
<h3 id=4-include-comments>
4. Include comments.
<a class=anchor href=#4-include-comments>#</a>
</h3>
<p>Both in the beginning of the code snippet to say what data the snippet pulls, the business logic it includes, and throughout, as much as possible, to reference subqueries. SQL makes it hard to read through an entire piece of code without running specific pieces one by one to get where you&rsquo;re going and comments will help jog the memory. Include them at the end of lines in code, or in blocks at the beginning of code.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql>
<span style=color:#75715e>/*Pulls a sample of 1000 random Nutella orders
</span><span style=color:#75715e> by month from the Northeast and excludes 16-oz sized jars. 
</span><span style=color:#75715e>Orders without monetary transactions are excluded, too. 
</span><span style=color:#75715e>Pulls into R script for regression analysis. */</span>	

<span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> trans a <span style=color:#75715e>--transactions table 
</span><span style=color:#75715e></span><span style=color:#66d9ef>JOIN</span> region b <span style=color:#75715e>--region table with 5 splits
</span><span style=color:#75715e></span><span style=color:#66d9ef>ON</span> a.trans_id<span style=color:#f92672>=</span>b.regionid
<span style=color:#66d9ef>WHERE</span> a.product_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;nutella&#39;</span>
<span style=color:#66d9ef>AND</span> b.regionid<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;NE&#39;</span> <span style=color:#75715e>--NE=northeast
</span><span style=color:#75715e></span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> RAND() <span style=color:#75715e>--selecting a random sample of 100
</span><span style=color:#75715e></span><span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>100</span>
</code></pre></div><h3 id=5-use-short-but-concise-table-aliases>
5. Use short but concise table aliases
<a class=anchor href=#5-use-short-but-concise-table-aliases>#</a>
</h3>
<p>You&rsquo;re probably doing a lot of joins. You want to see what those joins are doing. If you have a transactions_table, you don&rsquo;t want to alias it as transactions_table because that becomes too cluttered. Call it <code>trans</code>. <code>t</code> is too short and probably won&rsquo;t mean anything when you try to read the code back and translate it into business logic.</p>
<h3 id=6-use-indentation-if-you-have-multiple-subqueries-its-much-easier-to-read-where-the-subqueries-came-from>
6. Use indentation. If you have multiple subqueries, it&rsquo;s much easier to read where the subqueries came from.
<a class=anchor href=#6-use-indentation-if-you-have-multiple-subqueries-its-much-easier-to-read-where-the-subqueries-came-from>#</a>
</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql>
<span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> tablex
<span style=color:#66d9ef>JOIN</span> 
   (<span style=color:#66d9ef>SELECT</span> a, b 
    <span style=color:#66d9ef>FROM</span> tabley
    <span style=color:#66d9ef>WHERE</span> x<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;5&#39;</span>) ysub
<span style=color:#66d9ef>WHERE</span> variabley<span style=color:#f92672>=</span>z 
<span style=color:#66d9ef>AND</span> variablea<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span>
<span style=color:#66d9ef>AND</span> variableb<span style=color:#f92672>=</span><span style=color:#ae81ff>15</span>
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> RAND()
<span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>1</span>
</code></pre></div><p>is more legible than</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql>
<span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> tablex
<span style=color:#66d9ef>JOIN</span> (<span style=color:#66d9ef>select</span> a, b <span style=color:#66d9ef>from</span> tabley <span style=color:#66d9ef>where</span> x<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;5&#39;</span>) ysub
<span style=color:#66d9ef>where</span> variabley<span style=color:#f92672>=</span>z 
<span style=color:#66d9ef>AND</span> variablea<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span>
<span style=color:#66d9ef>AND</span> variableb<span style=color:#f92672>=</span><span style=color:#ae81ff>15</span>
<span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> RAND()
<span style=color:#66d9ef>limit</span> <span style=color:#ae81ff>1</span>
</code></pre></div><h3 id=7-make-new-tables>
7. Make new tables.
<a class=anchor href=#7-make-new-tables>#</a>
</h3>
<p>If you find your query becoming longer than some random threshold you set for yourself, i.e. 15 lines or so AND you find yourself running it over and over, it&rsquo;s probably time to create a permanent table for your data.</p>
<p>Here&rsquo;s another great post I referenced while writing this one:</p>
<ul>
<li><a href=http://programmers.stackexchange.com/questions/144602/how-do-i-make-complex-sql-queries-easier-to-write>How do I make complex SQL queries easier to write? on Stack Overflow</a></li>
</ul>
</article>
<footer class=book-footer>
<div class="flex flex-wrap justify-between">
<div><a class="flex align-center" href=https://github.com/veekaybee/boringml/commit/c47da529a1b8abafdb165b1d870b307a55ecce6c title="Last modified by Vicki Boykis | Jan 6, 2022" target=_blank rel=noopener>
<img src=/svg/calendar.svg class=book-icon alt=Calendar>
<span>Jan 6, 2022</span>
</a>
</div>
</div>
<script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script>
</footer>
<div class=book-comments>
</div>
<label for=menu-control class="hidden book-menu-overlay"></label>
</div>
</main>
</body>
</html>